import os
import requests
import hashlib
import difflib
from email.message import EmailMessage
import smtplib

URL = os.environ.get("MONITOR_URL")
LAST_HASH_FILE = "last_hash.txt"

SMTP_HOST = os.environ.get("SMTP_HOST")
SMTP_PORT = int(os.environ.get("SMTP_PORT", 587))
SMTP_USER = os.environ.get("SMTP_USER")
SMTP_PASS = os.environ.get("SMTP_PASS")
EMAIL_TO = os.environ.get("EMAIL_TO")

HEADERS = {
    "User-Agent": "Mozilla/5.0 (compatible; monitor-bot/1.0)"
}

def fetch():
    r = requests.get(URL, headers=HEADERS, timeout=30)
    r.raise_for_status()
    return r.text

def get_hash(text):
    return hashlib.md5(text.encode("utf-8")).hexdigest()

def read_last():
    try:
        with open(LAST_HASH_FILE, "r") as f:
            return f.read().strip()
    except:
        return ""

def save_hash(h):
    with open(LAST_HASH_FILE, "w") as f:
        f.write(h)

def send_email(subject, body):
    msg = EmailMessage()
    msg["From"] = SMTP_USER
    msg["To"] = EMAIL_TO
    msg["Subject"] = subject
    msg.set_content(body)

    with smtplib.SMTP(SMTP_HOST, SMTP_PORT) as server:
        server.starttls()
        server.login(SMTP_USER, SMTP_PASS)
        server.send_message(msg)

def main():
    current = fetch()
    current_hash = get_hash(current)
    last_hash = read_last()

    if current_hash != last_hash:
        diff = "\n".join(
            difflib.unified_diff(
                [], current.splitlines(),
                lineterm=""
            )
        )

        send_email(
            "【更新検知】Vaundyストア商品ページ",
            f"変更を検知しました。\n\nURL:\n{URL}\n\n差分（冒頭部分）:\n{diff[:3000]}"
        )

        save_hash(current_hash)
        print("Updated & notified")
    else:
        print("No change")

if __name__ == "__main__":
    main()
